package datdq0317.edu.ut.vn.dinhquocdat.userservice.controllers;

import datdq0317.edu.ut.vn.dinhquocdat.userservice.Auth.CustomUserDetailsService;
import datdq0317.edu.ut.vn.dinhquocdat.userservice.Auth.JwtUtil;
import datdq0317.edu.ut.vn.dinhquocdat.userservice.dtos.TaiXeDTO;
import datdq0317.edu.ut.vn.dinhquocdat.userservice.models.NguoiDung;
import datdq0317.edu.ut.vn.dinhquocdat.userservice.models.TaiXe;
import datdq0317.edu.ut.vn.dinhquocdat.userservice.repositories.INguoiDungRepository;


import datdq0317.edu.ut.vn.dinhquocdat.userservice.services.INguoiDungService;
import datdq0317.edu.ut.vn.dinhquocdat.userservice.services.ITaiXeService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.security.authentication.*;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.crypto.bcrypt.BCrypt;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.web.bind.annotation.*;

import java.time.LocalDate;
import java.util.*;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.authentication.*;
import org.springframework.web.bind.annotation.*;

import java.util.*;

@RestController
@RequestMapping("/api/user-service/auth")
public class AuthController {

    @Autowired
    private AuthenticationManager authenticationManager;

    @Autowired
    private INguoiDungService nguoiDungService;

    @Autowired
    private ITaiXeService taiXeService;

    @Autowired
    private JwtUtil jwtUtil;
    @Autowired  // TH√äM D√íNG N√ÄY
    private CustomUserDetailsService customUserDetailsService;
    @Autowired
    private PasswordEncoder passwordEncoder;

//    /**
//     * API ƒëƒÉng k√Ω ng∆∞·ªùi d√πng
//     */
//    @PostMapping("/register")
//    public Map<String, Object> register(@RequestBody NguoiDung nguoiDung) {
//        NguoiDung saved = nguoiDungService.dangKy(nguoiDung);
//        return Map.of(
//                "message", "ƒêƒÉng k√Ω th√†nh c√¥ng",
//                "userId", saved.getMaNguoiDung(),
//                "email", saved.getEmail()
//        );
//    }
//
//    /**
//     * API ƒëƒÉng nh·∫≠p, tr·∫£ v·ªÅ JWT Token
//     */
//    @PostMapping("/login")
//    public Map<String, Object> login(@RequestBody Map<String, String> body) {
//        String email = body.get("email");
//        String matKhau = body.get("matKhau");
//
//        authenticationManager.authenticate(
//                new UsernamePasswordAuthenticationToken(email, matKhau)
//        );
//
//        NguoiDung user = nguoiDungService.timTheoEmail(email)
//                .orElseThrow(() -> new RuntimeException("Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng!"));
//
//        String token = jwtUtil.generateToken(user.getEmail(), user.getVaiTro());
//
//        return Map.of(
//                "token", token,
//                "role", user.getVaiTro(),
//                "email", user.getEmail()
//        );
//    }
//    @PostMapping("/register-tai-xe")
//    public Map<String, Object> registerTaiXe(@RequestBody TaiXeDTO dto) {
//        System.out.println("ƒê√£ v√†o API /register-tai-xe v·ªõi DTO: " + dto);
//        TaiXe taiXe = taiXeService.themTaiXe(dto);
//        System.out.println("T·∫°o t√†i x·∫ø th√†nh c√¥ng: " + taiXe.getMaTaiXe());
//        return Map.of(
//                "message", "ƒêƒÉng k√Ω t√†i x·∫ø th√†nh c√¥ng",
//                "taiXeId", taiXe.getMaTaiXe(),
//                "nguoiDungId", taiXe.getNguoiDung().getMaNguoiDung(),
//                "email", taiXe.getNguoiDung().getEmail()
//        );
//    }
    /**
     * API ƒëƒÉng k√Ω ng∆∞·ªùi d√πng
     */
    @PostMapping("/register-admin")
    public ResponseEntity<?> register(@RequestBody NguoiDung nguoiDung) {
        try {
            // üö® XO√Å D√íNG N√ÄY - KH√îNG ENCODE ·ªû ƒê√ÇY
            // nguoiDung.setMatKhau(passwordEncoder.encode(nguoiDung.getMatKhau()));

            nguoiDung.setNgayTao(LocalDate.now());

            // Set role m·∫∑c ƒë·ªãnh n·∫øu ch∆∞a c√≥
            if (nguoiDung.getVaiTro() == null || nguoiDung.getVaiTro().isEmpty()) {
                nguoiDung.setVaiTro("USER");
            }

            NguoiDung saved = nguoiDungService.dangKy(nguoiDung); // Service s·∫Ω encode

            Map<String, Object> response = new HashMap<>();
            response.put("message", "ƒêƒÉng k√Ω th√†nh c√¥ng");
            response.put("userId", saved.getMaNguoiDung());
            response.put("email", saved.getEmail());

            return ResponseEntity.ok(response);
        } catch (Exception e) {
            Map<String, String> error = new HashMap<>();
            error.put("error", "ƒêƒÉng k√Ω th·∫•t b·∫°i: " + e.getMessage());
            return ResponseEntity.badRequest().body(error);
        }
    }

    /**
     * API ƒëƒÉng nh·∫≠p, tr·∫£ v·ªÅ JWT Token
     */

    @PostMapping("/login")
    public ResponseEntity<?> login(@RequestBody Map<String, String> body) {
        try {
            System.out.println("üéØ === B·∫ÆT ƒê·∫¶U LOGIN ===");

            String soDienThoai = body.get("soDienThoai");
            String matKhau = body.get("matKhau");

            System.out.println("üì± S·ªë ƒëi·ªán tho·∫°i: " + soDienThoai);
            System.out.println("üîê M·∫≠t kh·∫©u: " + matKhau);

            // T√¨m user
            System.out.println("üîç T√¨m user v·ªõi SƒêT: " + soDienThoai);
            Optional<NguoiDung> userOpt = nguoiDungService.timTheoSoDienThoai(soDienThoai);

            if (!userOpt.isPresent()) {
                System.out.println("‚ùå KH√îNG T√åM TH·∫§Y USER");
                Map<String, String> error = new HashMap<>();
                error.put("error", "S·ªë ƒëi·ªán tho·∫°i kh√¥ng t·ªìn t·∫°i");
                return ResponseEntity.badRequest().body(error);
            }

            NguoiDung user = userOpt.get(); // üéØ QUAN TR·ªåNG: L·∫•y user t·ª´ Optional
            System.out.println("‚úÖ T√åM TH·∫§Y USER:");
            System.out.println("   - ID: " + user.getMaNguoiDung());
            System.out.println("   - T√™n: " + user.getHoTen());
            System.out.println("   - Vai tr√≤: " + user.getVaiTro());
            System.out.println("   - M·∫≠t kh·∫©u DB: " + user.getMatKhau());

            // üî• DEBUG CHI TI·∫æT SO S√ÅNH M·∫¨T KH·∫®U
            System.out.println("üîë === DEBUG PASSWORD MATCHING ===");
            System.out.println("   - Input password: '" + matKhau + "'");
            System.out.println("   - DB password: '" + user.getMatKhau() + "'");
            System.out.println("   - DB password length: " + user.getMatKhau().length());
            System.out.println("   - Is BCrypt: " + user.getMatKhau().startsWith("$2a$"));

            // Test nhi·ªÅu c√°ch
            boolean match1 = passwordEncoder.matches(matKhau, user.getMatKhau());
            System.out.println("   - passwordEncoder.matches(): " + match1);

            // Test v·ªõi kho·∫£ng tr·∫Øng
            boolean match2 = passwordEncoder.matches(matKhau.trim(), user.getMatKhau());
            System.out.println("   - With trim(): " + match2);

            // Test manual BCrypt
            try {
                boolean match3 = BCrypt.checkpw(matKhau, user.getMatKhau());
                System.out.println("   - BCrypt.checkpw(): " + match3);
            } catch (Exception e) {
                System.out.println("   - BCrypt.checkpw() error: " + e.getMessage());
            }

            if (!match1) {
                System.out.println("‚ùå T·∫§T C·∫¢ SO S√ÅNH M·∫¨T KH·∫®U ƒê·ªÄU FAIL!");
                Map<String, String> error = new HashMap<>();
                error.put("error", "S·ªë ƒëi·ªán tho·∫°i ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng");
                error.put("debug", "Password mismatch - check input");
                return ResponseEntity.badRequest().body(error);
            }

            System.out.println("‚úÖ M·∫¨T KH·∫®U KH·ªöP!");

            // Ti·∫øp t·ª•c x·ª≠ l√Ω login th√†nh c√¥ng...
            UserDetails userDetails = customUserDetailsService.loadUserByUsername(soDienThoai);
            UsernamePasswordAuthenticationToken authentication =
                    new UsernamePasswordAuthenticationToken(userDetails, null, userDetails.getAuthorities());
            SecurityContextHolder.getContext().setAuthentication(authentication);

            System.out.println("üé´ T·∫°o token...");
            // T·∫°o token v·ªõi s·ªë ƒëi·ªán tho·∫°i
            String token = jwtUtil.generateToken(user.getSoDienThoai(), user.getVaiTro());
            System.out.println("‚úÖ Token created successfully");

            // Test token ngay
            try {
                String testExtract = jwtUtil.extractSoDienThoai(token);
                String testRole = jwtUtil.extractRole(token);
                boolean testValid = jwtUtil.isTokenValid(token, user.getSoDienThoai());

                System.out.println("üß™ Token test:");
                System.out.println("   - Extract SƒêT: " + testExtract);
                System.out.println("   - Extract Role: " + testRole);
                System.out.println("   - Is Valid: " + testValid);
            } catch (Exception e) {
                System.out.println("‚ùå Token test failed: " + e.getMessage());
                throw e;
            }

            Map<String, Object> response = new HashMap<>();
            response.put("token", token);
            response.put("role", user.getVaiTro());
            response.put("email", user.getEmail());
            response.put("soDienThoai", user.getSoDienThoai());
            response.put("userId", user.getMaNguoiDung());
            response.put("hoTen", user.getHoTen());

            System.out.println("üéâ LOGIN TH√ÄNH C√îNG!");
            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.out.println("üí• L·ªñI LOGIN: " + e.getClass().getSimpleName());
            System.out.println("üí• Message: " + e.getMessage());
            e.printStackTrace();

            Map<String, String> error = new HashMap<>();
            error.put("error", "ƒêƒÉng nh·∫≠p th·∫•t b·∫°i: " + e.getMessage());
            return ResponseEntity.status(500).body(error);
        }
    }

    @PostMapping("/register-tai-xe")
    public ResponseEntity<?> registerTaiXe(@RequestBody TaiXeDTO dto) {
        try {
            System.out.println("ƒê√£ v√†o API /register-tai-xe v·ªõi DTO: " + dto);
            TaiXe taiXe = taiXeService.themTaiXe(dto);
            System.out.println("T·∫°o t√†i x·∫ø th√†nh c√¥ng: " + taiXe.getMaTaiXe());

            Map<String, Object> response = new HashMap<>();
            response.put("message", "ƒêƒÉng k√Ω t√†i x·∫ø th√†nh c√¥ng");
            response.put("taiXeId", taiXe.getMaTaiXe());
            response.put("nguoiDungId", taiXe.getNguoiDung().getMaNguoiDung());
            response.put("email", taiXe.getNguoiDung().getEmail());

            return ResponseEntity.ok(response);
        } catch (Exception e) {
            Map<String, String> error = new HashMap<>();
            error.put("error", "ƒêƒÉng k√Ω t√†i x·∫ø th·∫•t b·∫°i: " + e.getMessage());
            return ResponseEntity.badRequest().body(error);
        }
    }
}